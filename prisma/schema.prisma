generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  // legacy
  admin
  vet
  therapist
  receptionist

  // current role set
  veterinarian
  senior_therapist
  assistant_therapist
  hydrotherapist
  marketing
  office_manager
  administrator
}

enum PatientSex {
  male
  female
  neutered_male
  spayed_female
}

enum TreatmentPlanStatus {
  draft
  pending_approval
  active
  completed
  discontinued
}

enum AppointmentStatus {
  scheduled
  confirmed
  in_progress
  completed
  cancelled
  no_show
}

enum InvoiceStatus {
  draft
  sent
  paid
  partial
  overdue
  cancelled
}

enum PaymentMethod {
  cash
  card
  bank_transfer
  paynow
  other
}

enum DocumentCategory {
  xray
  lab_report
  photo
  document
  video
  other
}

model users {
  id               String    @id @default(uuid()) @db.Uuid
  email            String    @unique
  password_hash    String
  name             String
  role             UserRole
  phone            String?
  photo_url        String?
  specializations  String?   // JSON string
  schedule         String?   // JSON string: WeekSchedule
  active                Boolean   @default(true)
  failed_login_attempts Int       @default(0)
  locked_until          DateTime?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  // Relations
  created_plans    treatment_plans[] @relation("plans_created_by")
  approved_plans   treatment_plans[] @relation("plans_approved_by")
  appointments     appointments[]    @relation("appointments_therapist")
  sessions         sessions[]        @relation("sessions_therapist")
  documents        documents[]       @relation("documents_uploaded_by")

  @@map("users")
}

model clients {
  id            String   @id @default(uuid()) @db.Uuid
  client_number BigInt?  @unique
  name          String
  email         String?
  phone         String?
  address       String?
  notes         String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  patients         patients[]
  invoices         invoices[]
  appointments     appointments[]
  client_packages  client_packages[]

  @@index([name])
  @@index([phone])
  @@map("clients")
}

model patients {
  id              String      @id @default(uuid()) @db.Uuid
  client_id       String      @db.Uuid
  name            String
  species         String
  breed           String?
  date_of_birth   String?
  weight          Float?
  sex             PatientSex?
  microchip       String?
  medical_history String?
  allergies       String?
  notes           String?
  photo_url       String?
  active          Boolean     @default(true)
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt

  // Relations
  client           clients     @relation(fields: [client_id], references: [id])
  treatment_plans  treatment_plans[]
  appointments     appointments[]
  sessions         sessions[]
  invoices         invoices[]
  documents        documents[]
  client_packages  client_packages[]

  @@index([client_id])
  @@index([name])
  @@map("patients")
}

model treatment_plans {
  id                 String             @id @default(uuid()) @db.Uuid
  patient_id          String             @db.Uuid
  created_by          String?            @db.Uuid
  approved_by         String?            @db.Uuid
  title               String
  diagnosis            String?
  goals               String?
  modalities          String?            // JSON string
  frequency           String?
  total_sessions      Int?
  completed_sessions  Int                @default(0)
  status              TreatmentPlanStatus @default(draft)
  start_date          String?
  end_date            String?
  notes               String?
  created_at          DateTime           @default(now())
  updated_at          DateTime           @updatedAt

  patient             patients          @relation(fields: [patient_id], references: [id])
  created_by_user     users?            @relation("plans_created_by", fields: [created_by], references: [id])
  approved_by_user    users?            @relation("plans_approved_by", fields: [approved_by], references: [id])
  appointments        appointments[]
  sessions            sessions[]

  @@index([patient_id])
  @@index([status])
  @@map("treatment_plans")
}

model appointments {
  id                String            @id @default(uuid()) @db.Uuid
  patient_id         String            @db.Uuid
  client_id          String            @db.Uuid
  therapist_id       String?           @db.Uuid
  treatment_plan_id  String?           @db.Uuid
  date              String
  start_time        String
  end_time          String
  modality          String
  status            AppointmentStatus @default(scheduled)
  notes             String?
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt

  patient            patients         @relation(fields: [patient_id], references: [id])
  client             clients          @relation(fields: [client_id], references: [id])
  therapist          users?           @relation("appointments_therapist", fields: [therapist_id], references: [id])
  treatment_plan     treatment_plans? @relation(fields: [treatment_plan_id], references: [id])
  sessions           sessions[]

  @@index([date])
  @@index([therapist_id])
  @@index([patient_id])
  @@index([client_id])
  @@map("appointments")
}

model sessions {
  id                String   @id @default(uuid()) @db.Uuid
  appointment_id    String?  @db.Uuid
  patient_id        String   @db.Uuid
  therapist_id      String   @db.Uuid
  treatment_plan_id String?  @db.Uuid
  date              String
  modality          String
  duration_minutes  Int?
  // SOAP
  subjective        String?
  objective         String?
  assessment        String?
  plan              String?
  pain_score        Int?
  mobility_score    Int?
  progress_notes    String?
  measurements      String?  // JSON string
  exercises         String?  // JSON string
  home_exercises    String?  // JSON string
  // Clinical consultation fields (Annual Health Exam)
  heart_rate        Float?
  resp_rate         Float?
  temperature       Float?
  weight_session    Float?
  dental_score      Int?     // 0-4
  body_score        Float?   // 0-9
  flea_treatment    Boolean?
  wormed            Boolean?
  bloods            Boolean?
  history           String?
  clinical_examination String?
  diagnosis         String?
  treatment_notes   String?
  comments          String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  appointment        appointments?   @relation(fields: [appointment_id], references: [id])
  patient            patients        @relation(fields: [patient_id], references: [id])
  therapist          users           @relation("sessions_therapist", fields: [therapist_id], references: [id])
  treatment_plan     treatment_plans? @relation(fields: [treatment_plan_id], references: [id])
  invoice_items      invoice_items[]

  @@index([patient_id])
  @@index([date])
  @@index([therapist_id])
  @@map("sessions")
}

model invoices {
  id             String        @id @default(uuid()) @db.Uuid
  invoice_number String        @unique
  client_id      String        @db.Uuid
  patient_id     String?       @db.Uuid
  date           String
  due_date       String
  subtotal       Float         @default(0)
  tax            Float         @default(0)
  total          Float         @default(0)
  amount_paid    Float         @default(0)
  status         InvoiceStatus @default(draft)
  notes          String?
  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt

  client         clients       @relation(fields: [client_id], references: [id])
  patient        patients?     @relation(fields: [patient_id], references: [id])
  items          invoice_items[]
  payments       payments[]

  @@index([client_id])
  @@index([date])
  @@index([status])
  @@map("invoices")
}

model invoice_items {
  id           String   @id @default(uuid()) @db.Uuid
  invoice_id   String   @db.Uuid
  description  String
  modality     String?
  session_id   String?  @db.Uuid
  quantity     Int      @default(1)
  unit_price   Float
  total        Float
  created_at   DateTime @default(now())

  invoice      invoices @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
  session      sessions? @relation(fields: [session_id], references: [id])

  @@index([invoice_id])
  @@index([session_id])
  @@map("invoice_items")
}

model payments {
  id          String        @id @default(uuid()) @db.Uuid
  invoice_id  String        @db.Uuid
  amount      Float
  method      PaymentMethod?
  reference   String?
  date        String
  notes       String?
  created_at  DateTime      @default(now())

  invoice     invoices      @relation(fields: [invoice_id], references: [id])

  @@index([invoice_id])
  @@index([date])
  @@map("payments")
}

model documents {
  id           String           @id @default(uuid()) @db.Uuid
  patient_id   String           @db.Uuid
  uploaded_by  String?          @db.Uuid
  filename     String
  file_type    String?
  file_size    Int?
  file_path    String
  category     DocumentCategory?
  description  String?
  created_at   DateTime         @default(now())

  patient      patients         @relation(fields: [patient_id], references: [id])
  uploader     users?           @relation("documents_uploaded_by", fields: [uploaded_by], references: [id])

  @@index([patient_id])
  @@map("documents")
}

model leads {
  id              String    @id @default(uuid()) @db.Uuid
  // Owner info
  owner_name      String
  owner_email     String
  owner_phone     String
  post_code       String?
  how_heard       String?
  // Pet info
  pet_name        String
  species         String
  breed           String?
  age             String?
  weight          String?
  pet_gender      String?
  vet_friendly    Boolean?
  reactive_to_pets Boolean?
  // Visit info
  service         String?
  condition       String?
  has_pain        Boolean?
  clinic_name     String?
  attending_vet   String?
  preferred_date  String?
  first_visit     Boolean   @default(true)
  notes           String?
  // Pipeline
  status          String    @default("new")
  staff_notes     String?
  // Conversion
  converted_client_id      String?   @db.Uuid
  converted_patient_id     String?   @db.Uuid
  converted_appointment_id String?   @db.Uuid
  // Timestamps
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
}

model inventory_items {
  id            String   @id @default(uuid()) @db.Uuid
  sku           String?
  name          String
  category      String   @default("General")
  brand         String?
  cost_price    Float?
  sell_price    Float?
  markup_pct    Float?
  stock_on_hand Int      @default(0)
  stock_min     Int      @default(1)
  stock_max     Int      @default(10)
  unit          String   @default("each")
  expiry_date   String?
  is_active     Boolean  @default(true)
  notes         String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  movements     stock_movements[]
  @@map("inventory_items")
}

model stock_movements {
  id          String   @id @default(uuid()) @db.Uuid
  item_id     String   @db.Uuid
  type        String   // in, out, adjustment, sale, return
  quantity    Int
  reference   String?
  notes       String?
  created_by  String?
  created_at  DateTime @default(now())
  item        inventory_items @relation(fields: [item_id], references: [id], onDelete: Cascade)
  @@map("stock_movements")
}

model clinic_settings {
  id         String   @id @default("default")
  data       String   // JSON string of all settings
  updated_at DateTime @updatedAt

  @@map("clinic_settings")
}

model treatment_types {
  id                  String   @id @default(uuid()) @db.Uuid
  name                String   @unique
  category            String
  description         String?
  duration            Int      @default(60)
  price               Float?
  sessions_in_package Int?
  color               String?  @default("bg-gray-400")
  active              Boolean  @default(true)
  sort_order          Int      @default(0)
  created_at          DateTime @default(now())

  client_packages  client_packages[]
  service_pricing  service_pricing[]

  @@index([category])
  @@map("treatment_types")
}

model service_pricing {
  id         String          @id @default(uuid()) @db.Uuid
  service_id String          @db.Uuid
  label      String
  sessions   Int             @default(1)
  price      Float
  created_at DateTime        @default(now())

  service    treatment_types @relation(fields: [service_id], references: [id])

  @@index([service_id])
  @@map("service_pricing")
}

model client_packages {
  id                String   @id @default(uuid()) @db.Uuid
  client_id         String   @db.Uuid
  patient_id        String?  @db.Uuid
  treatment_type_id String   @db.Uuid
  sessions_total    Int
  sessions_used     Int      @default(0)
  purchase_date     String
  expiry_date       String?
  price_paid        Float?
  notes             String?
  status            String   @default("active")
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  client         clients         @relation(fields: [client_id], references: [id])
  patient        patients?       @relation(fields: [patient_id], references: [id])
  treatment_type treatment_types @relation(fields: [treatment_type_id], references: [id])
  usage_logs     package_usage_logs[]

  @@index([client_id])
  @@index([status])
  @@map("client_packages")
}

model email_campaigns {
  id               String    @id @default(uuid()) @db.Uuid
  name             String
  subject          String
  preheader        String?
  body_blocks      String    @db.Text
  body_html        String    @db.Text
  status           String    @default("draft")
  audience         String    @default("all")
  total_recipients Int       @default(0)
  sent_count       Int       @default(0)
  opened_count     Int       @default(0)
  clicked_count    Int       @default(0)
  sent_at          DateTime?
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  recipients       email_campaign_recipients[]
  @@map("email_campaigns")
}

model email_campaign_recipients {
  id           String   @id @default(uuid()) @db.Uuid
  campaign_id  String   @db.Uuid
  client_id    String   @db.Uuid
  email        String
  name         String
  resend_id    String?
  status       String   @default("pending")
  error        String?
  sent_at      DateTime?
  opened_at    DateTime?
  clicked_at   DateTime?
  campaign     email_campaigns @relation(fields: [campaign_id], references: [id], onDelete: Cascade)
  @@unique([campaign_id, client_id])
  @@index([campaign_id])
  @@index([email])
  @@map("email_campaign_recipients")
}

model email_unsubscribes {
  id         String   @id @default(uuid()) @db.Uuid
  email      String   @unique
  reason     String?
  created_at DateTime @default(now())
  @@map("email_unsubscribes")
}

model package_usage_logs {
  id             String   @id @default(uuid()) @db.Uuid
  package_id     String   @db.Uuid
  appointment_id String?  @db.Uuid
  used_date      String
  notes          String?
  created_at     DateTime @default(now())

  package client_packages @relation(fields: [package_id], references: [id])

  @@map("package_usage_logs")
}
